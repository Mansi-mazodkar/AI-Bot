<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pookie AI ✨ Your Smart Bestie</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Fredoka:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        :root {
            --bg-color: #0D0D1A;
            --text-color: #e0e0e0;
            --primary-accent: #a855f7;
            --secondary-accent: #ec4899;
            --glass-bg: rgba(26, 26, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --user-bubble: #3a3a5a;
            --ai-bubble: #1e1e28;
            --font-main: 'Poppins', sans-serif;
            --font-display: 'Fredoka', sans-serif;
        }

        /* --- Theme Definitions --- */
        .theme-dark { --bg-color: #0D0D1A; --text-color: #e0e0e0; --primary-accent: #a855f7; --secondary-accent: #ec4899; --glass-bg: rgba(26, 26, 42, 0.6); --glass-border: rgba(255, 255, 255, 0.1); --user-bubble: #3a3a5a; --ai-bubble: #1e1e28; }
        .theme-light { --bg-color: #f0f2f5; --text-color: #333; --primary-accent: #8b5cf6; --secondary-accent: #db2777; --glass-bg: rgba(255, 255, 255, 0.6); --glass-border: rgba(0, 0, 0, 0.1); --user-bubble: #e9e9eb; --ai-bubble: #ffffff; }
        .theme-cyberpunk { --bg-color: #010101; --text-color: #00f2fe; --primary-accent: #7c05f2; --secondary-accent: #fd1d53; --glass-bg: rgba(1, 1, 1, 0.6); --glass-border: rgba(124, 5, 242, 0.5); --user-bubble: #1a1a3e; --ai-bubble: #10102a; }
        .theme-cute { --bg-color: #fce4ec; --text-color: #880e4f; --primary-accent: #ff80ab; --secondary-accent: #f48fb1; --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(255, 128, 171, 0.5); --user-bubble: #f8bbd0; --ai-bubble: #ffffff; }
        .theme-galaxy { --bg-color: #000428; --text-color: #fff; --primary-accent: #6a11cb; --secondary-accent: #2575fc; --glass-bg: rgba(0, 4, 40, 0.7); --glass-border: rgba(255, 255, 255, 0.2); --user-bubble: #002b5c; --ai-bubble: #001a35; }
        .theme-minimalist { --bg-color: #e5e7eb; --text-color: #111827; --primary-accent: #4f46e5; --secondary-accent: #6b7280; --glass-bg: rgba(255, 255, 255, 0.8); --glass-border: rgba(0, 0, 0, 0.1); --user-bubble: #d1d5db; --ai-bubble: #ffffff; }
        .theme-sunset { --bg-color: #2c1e3e; --text-color: #fde68a; --primary-accent: #f97316; --secondary-accent: #ec4899; --glass-bg: rgba(44, 30, 62, 0.7); --glass-border: rgba(249, 115, 22, 0.4); --user-bubble: #7c2d12; --ai-bubble: #4a1d42; }
        .theme-ocean { --bg-color: #0c2a4d; --text-color: #e0f2fe; --primary-accent: #0ea5e9; --secondary-accent: #14b8a6; --glass-bg: rgba(12, 42, 77, 0.7); --glass-border: rgba(14, 165, 233, 0.4); --user-bubble: #083344; --ai-bubble: #164e63; }
        .theme-forest { --bg-color: #1a2e23; --text-color: #d4d4d4; --primary-accent: #22c55e; --secondary-accent: #84cc16; --glass-bg: rgba(26, 46, 35, 0.7); --glass-border: rgba(34, 197, 94, 0.4); --user-bubble: #14532d; --ai-bubble: #166534; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* --- Aurora Background --- */
        .aurora-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .aurora { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.4; animation: moveAurora 20s infinite alternate; }
        .aurora1 { background: var(--primary-accent); width: 400px; height: 400px; top: 10%; left: 10%; }
        .aurora2 { background: var(--secondary-accent); width: 300px; height: 300px; top: 60%; left: 30%; animation-delay: 5s; }
        .aurora3 { background: #4f46e5; width: 350px; height: 350px; top: 30%; left: 70%; animation-delay: 10s; }
        @keyframes moveAurora { from { transform: translate(0, 0) scale(1); } to { transform: translate(100px, 50px) scale(1.2); } }

        /* --- Main Layout --- */
        .app-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .chat-wrapper { width: 100%; max-width: 900px; height: 95vh; background: var(--glass-bg); backdrop-filter: blur(30px) saturate(180%); border-radius: 24px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); position: relative; }

        /* --- Sidebar (Slide-in Panel) --- */
        .sidebar { position: absolute; top: 0; left: -320px; width: 300px; height: 100%; background: rgba(13, 13, 26, 0.8); backdrop-filter: blur(20px); padding: 1.5rem; z-index: 100; transition: left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; }
        .sidebar.open { left: 0; }
        .sidebar-title { font-family: var(--font-display); font-size: 1.5rem; margin-bottom: 2rem; }
        .sidebar-section-title { font-weight: 600; margin: 1.5rem 0 0.5rem 0; opacity: 0.7; font-size: 0.9rem; }
        .theme-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        .theme-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--glass-border); cursor: pointer; transition: transform 0.2s ease; }
        .theme-btn:hover, .theme-btn.active { transform: scale(1.15); border-color: var(--primary-accent); }
        #theme-dark { background: #0D0D1A; } #theme-light { background: #f0f2f5; } #theme-cyberpunk { background: #010101; } #theme-cute { background: #fce4ec; } #theme-galaxy { background: #000428; } #theme-minimalist { background: #e5e7eb; } #theme-sunset { background: #2c1e3e; } #theme-ocean { background: #0c2a4d; } #theme-forest { background: #1a2e23; }

        /* --- Chat Header --- */
        .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .menu-toggle, .header-button { background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease; }
        .menu-toggle:hover, .header-button:hover { color: var(--primary-accent); transform: scale(1.1); }
        .header-title { display: flex; align-items: center; gap: 0.75rem; }
        .ai-avatar-small { font-size: 1.5rem; }
        .header-title h2 { font-size: 1.2rem; font-weight: 600; font-family: var(--font-display); }

        /* --- Quick Prompts (Story Style) --- */
        .quick-prompts { padding: 1rem 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; gap: 1rem; overflow-x: auto; scrollbar-width: none; }
        .quick-prompts::-webkit-scrollbar { display: none; }
        .prompt-story { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; cursor: pointer; }
        .prompt-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border: 2px solid var(--primary-accent); background: linear-gradient(45deg, var(--user-bubble), var(--ai-bubble)); transition: transform 0.3s ease; }
        .prompt-story:hover .prompt-icon { transform: scale(1.1); }
        .prompt-label { font-size: 0.75rem; opacity: 0.8; }

        /* --- Chat History --- */
        .chat-history { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; }
        .chat-message { display: flex; margin-bottom: 1.5rem; max-width: 80%; animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .message-bubble { padding: 1rem; border-radius: 20px; position: relative; }
        .user-message { align-self: flex-end; flex-direction: row-reverse; }
        .user-message .message-bubble { background: var(--user-bubble); border-bottom-right-radius: 5px; }
        .ai-message { align-self: flex-start; }
        .ai-message .message-bubble { background: var(--ai-bubble); border-bottom-left-radius: 5px; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; background: linear-gradient(45deg, var(--primary-accent), var(--secondary-accent)); display: flex; align-items: center; justify-content: center; align-self: flex-end; }
        .user-message .message-avatar { background: linear-gradient(45deg, #6d28d9, #be185d); }
        .message-content p { margin: 0; line-height: 1.6; }
        .message-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; opacity: 0; transition: opacity 0.3s ease; }
        .chat-message:hover .message-actions { opacity: 1; }
        .action-btn { background: none; border: none; color: var(--text-color); opacity: 0.6; cursor: pointer; font-size: 1rem; }
        .action-btn:hover { opacity: 1; color: var(--primary-accent); }
        .reactions { position: absolute; bottom: -15px; left: 10px; background: var(--ai-bubble); border-radius: 10px; padding: 2px 5px; font-size: 0.8rem; display: flex; gap: 4px; }
        .typing-indicator span { width: 8px; height: 8px; background-color: var(--primary-accent); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* --- Chat Input --- */
        .chat-input-area { padding: 1rem 1.5rem; border-top: 1px solid var(--glass-border); flex-shrink: 0; }
        .input-wrapper { display: flex; align-items: center; background: var(--ai-bubble); border-radius: 15px; padding: 0.5rem; border: 1px solid transparent; transition: border-color 0.3s ease; }
        .input-wrapper:focus-within { border-color: var(--primary-accent); }
        #chatInput { flex-grow: 1; border: none; background: transparent; color: var(--text-color); font-size: 1rem; padding: 0.5rem; outline: none; }
        .input-button { background: none; border: none; color: var(--text-color); opacity: 0.7; font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease; margin-left: 0.5rem; padding: 0.5rem; }
        .input-button:hover { opacity: 1; color: var(--primary-accent); transform: scale(1.1); }
        #sendButton { background: var(--primary-accent); color: white; border-radius: 10px; opacity: 1; }

        /* --- Vibe Check Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.5s; }
        .modal-content { background: var(--glass-bg); border: 1px solid var(--glass-border); padding: 2rem; border-radius: 20px; text-align: center; max-width: 400px; }
        .modal-title { font-size: 1.8rem; font-family: var(--font-display); margin-bottom: 1rem; }
        .vibe-options { display: flex; gap: 1.5rem; margin-top: 1.5rem; justify-content: center; }
        .vibe-btn { font-size: 3rem; background: none; border: none; cursor: pointer; transition: transform 0.2s ease; }
        .vibe-btn:hover { transform: scale(1.2); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Utility & Responsive --- */
        .hidden { display: none; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--primary-accent); color: white; padding: 10px 20px; border-radius: 10px; z-index: 1001; animation: fadeInOut 3s; }
        @keyframes fadeInOut { 0%,100% { opacity: 0; bottom: 0px; } 10%,90% { opacity: 1; bottom: 20px; } }
        @media (max-width: 768px) { .app-container { padding: 0; } .chat-wrapper { height: 100vh; border-radius: 0; } .quick-prompts { padding: 0.5rem 1rem; } .chat-history { padding: 1rem; } .chat-input-area { padding: 0.5rem 1rem; } }
    </style>
</head>
<body>

    <div class="aurora-background">
        <div class="aurora aurora1"></div>
        <div class="aurora aurora2"></div>
        <div class="aurora aurora3"></div>
    </div>

    <div class="modal-overlay hidden" id="vibeModal">
        <div class="modal-content">
            <h2 class="modal-title">Daily Vibe Check ✨</h2>
            <p>Hey bestie! How are you feeling today?</p>
            <div class="vibe-options">
                <button class="vibe-btn" data-vibe="happy">😊</button>
                <button class="vibe-btn" data-vibe="meh">😐</button>
                <button class="vibe-btn" data-vibe="sad">😫</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Main Chat Area -->
        <main class="chat-wrapper">
            <header class="chat-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">☰</button>
                    <div class="header-title">
                        <span class="ai-avatar-small" id="aiAvatar">🤖</span>
                        <h2>Pookie AI</h2>
                    </div>
                </div>
                <div class="header-right">
                    <button class="header-button" id="soundToggle" title="Mute/Unmute">🔊</button>
                    <button class="header-button" id="downloadPdfBtn" title="Download Chat as PDF">📂</button>
                    <button class="header-button" id="clearChatBtn" title="Clear Chat">🗑️</button>
                </div>
            </header>

            <section class="quick-prompts" id="quickPrompts"></section>

            <div class="chat-history" id="chatHistory"></div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <input type="text" id="chatInput" placeholder="Ask me anything, bestie...">
                    <button class="input-button" id="micButton" title="Voice Input">🎤</button>
                    <button class="input-button" id="sendButton" title="Send">➤</button>
                </div>
            </div>
        </main>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <h2 class="sidebar-title">Settings</h2>
            <h3 class="sidebar-section-title">Themes</h3>
            <div class="theme-selector">
                <button class="theme-btn active" id="theme-dark" data-theme="dark"></button>
                <button class="theme-btn" id="theme-light" data-theme="light"></button>
                <button class="theme-btn" id="theme-cyberpunk" data-theme="cyberpunk"></button>
                <button class="theme-btn" id="theme-cute" data-theme="cute"></button>
                <button class="theme-btn" id="theme-galaxy" data-theme="galaxy"></button>
                <button class="theme-btn" id="theme-minimalist" data-theme="minimalist"></button>
                <button class="theme-btn" id="theme-sunset" data-theme="sunset"></button>
                <button class="theme-btn" id="theme-ocean" data-theme="ocean"></button>
                <button class="theme-btn" id="theme-forest" data-theme="forest"></button>
            </div>
        </aside>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const chatHistory = document.getElementById('chatHistory');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const micButton = document.getElementById('micButton');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
            const aiAvatar = document.getElementById('aiAvatar');
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const vibeModal = document.getElementById('vibeModal');
            const soundToggle = document.getElementById('soundToggle');

            // --- API Configuration ---
            // 🔑 PASTE YOUR GEMINI API KEY HERE!
            const API_KEY = "AIzaSyCahLK_h1YUV4yK8n3ZNkwUIH2KO1pC_d0"; 
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            // --- State Management ---
            let chat = [];
            let isRecording = false;
            let recognition;
            let isMuted = false;

            // --- Sound Effects ---
            const synth = new Tone.Synth().toDestination();
            const playSound = (type) => {
                if (isMuted) return;
                Tone.start().then(() => {
                    if (type === 'send') synth.triggerAttackRelease("C5", "8n");
                    else if (type === 'receive') synth.triggerAttackRelease("G5", "8n");
                });
            };
            
            // --- Quick Prompts ---
            const quickPromptsData = [
                { icon: '😂', label: 'Joke', prompt: 'Tell me a really funny, short joke.' },
                { icon: '💪', label: 'Motivation', prompt: 'Give me a short, powerful motivational quote.' },
                { icon: '🤯', label: 'Fun Fact', prompt: 'Tell me a mind-blowing, random fun fact.' },
                { icon: '🔮', label: 'Horoscope', prompt: 'Give me a fun, positive daily horoscope for a Gemini.' },
                { icon: '💖', label: 'Compliment', prompt: 'Give me a super sweet and unique compliment.' }
            ];
            const renderQuickPrompts = () => {
                const container = document.getElementById('quickPrompts');
                container.innerHTML = '';
                quickPromptsData.forEach(item => {
                    const storyEl = document.createElement('div');
                    storyEl.className = 'prompt-story';
                    storyEl.innerHTML = `<div class="prompt-icon">${item.icon}</div><span class="prompt-label">${item.label}</span>`;
                    storyEl.addEventListener('click', () => { chatInput.value = item.prompt; sendMessage(); });
                    container.appendChild(storyEl);
                });
            };

            // --- Vibe Check ---
            const handleVibeCheck = (vibe) => {
                let prompt = '';
                if (vibe === 'happy') prompt = "I'm feeling amazing today! Give me a message to keep the good vibes going!";
                else if (vibe === 'meh') prompt = "I'm feeling a bit 'meh' today. Give me a little pick-me-up.";
                else if (vibe === 'sad') prompt = "I'm feeling a bit down today. Can you send me a comforting message?";
                
                chatInput.value = prompt;
                sendMessage();
                vibeModal.classList.add('hidden');
            };

            // --- Core Chat Functions ---
            const sendMessage = async () => {
                const userInput = chatInput.value.trim();
                if (userInput === '') return;

                addMessageToChat('user', userInput);
                playSound('send');
                chatInput.value = '';
                showTypingIndicator();

                try {
                    const aiResponse = await getAiResponse(userInput);
                    addMessageToChat('ai', aiResponse);
                    playSound('receive');
                } catch (error) {
                    console.error("Error fetching AI response:", error);
                    addMessageToChat('ai', "OMG, my brain just short-circuited. 🤯 Try again maybe?");
                } finally {
                    hideTypingIndicator();
                }
            };

            const getAiResponse = async (prompt) => {
                if (!API_KEY || API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                    return "Bestie, you forgot to add the API key! 🤫 Paste it into the `API_KEY` variable in the script to get me working.";
                }
                
                const payload = {
                    contents: chat.map(msg => ({ role: msg.sender === 'ai' ? 'model' : 'user', parts: [{ text: msg.text }] })).concat([{ role: "user", parts: [{ text: prompt }] }])
                };

                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                }
                return "I'm literally speechless... something went wrong. 🤷‍♀️";
            };

            // --- UI & DOM Manipulation ---
            const addMessageToChat = (sender, text) => {
                chat.push({ sender, text });
                const messageElement = document.createElement('div');
                messageElement.className = `chat-message ${sender}-message`;
                const avatar = sender === 'ai' ? '🤖' : '�';
                
                messageElement.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-bubble">
                        <div class="message-content"></div>
                        ${sender === 'ai' ? `
                        <div class="message-actions">
                            <button class="action-btn copy-btn" title="Copy">📋</button>
                            <button class="action-btn speak-btn" title="Read Aloud">🔊</button>
                            <button class="action-btn react-btn" data-emoji="😍">😍</button>
                            <button class="action-btn react-btn" data-emoji="😂">😂</button>
                            <button class="action-btn react-btn" data-emoji="🔥">🔥</button>
                        </div>` : ''}
                    </div>`;
                
                chatHistory.appendChild(messageElement);
                typewriterEffect(messageElement.querySelector('.message-content'), text);

                if (sender === 'ai') {
                    messageElement.querySelector('.copy-btn').addEventListener('click', () => copyToClipboard(text));
                    messageElement.querySelector('.speak-btn').addEventListener('click', () => speakText(text));
                    messageElement.querySelectorAll('.react-btn').forEach(btn => {
                        btn.addEventListener('click', () => addReaction(messageElement, btn.dataset.emoji));
                    });
                }
            };
            
            const typewriterEffect = (element, text) => {
                let i = 0;
                element.innerHTML = "";
                const p = document.createElement('p');
                element.appendChild(p);
                const typingInterval = setInterval(() => {
                    if (i < text.length) {
                        p.textContent += text.charAt(i++);
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    } else {
                        clearInterval(typingInterval);
                    }
                }, 15);
            };

            let typingIndicator;
            const showTypingIndicator = () => {
                aiAvatar.textContent = '🤔';
                if (typingIndicator) return;
                typingIndicator = document.createElement('div');
                typingIndicator.className = 'chat-message ai-message';
                typingIndicator.innerHTML = `<div class="message-avatar">🤖</div><div class="message-bubble"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
                chatHistory.appendChild(typingIndicator);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            };

            const hideTypingIndicator = () => {
                aiAvatar.textContent = '🤖';
                if (typingIndicator) {
                    typingIndicator.remove();
                    typingIndicator = null;
                }
            };
            
            const showToast = (message) => {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            };
            
            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard! 📋'));
            };
            
            const speakText = (text) => {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                speechSynthesis.speak(utterance);
            };
            
            const addReaction = (messageElement, emoji) => {
                let reactionContainer = messageElement.querySelector('.reactions');
                if (!reactionContainer) {
                    reactionContainer = document.createElement('div');
                    reactionContainer.className = 'reactions';
                    messageElement.querySelector('.message-bubble').appendChild(reactionContainer);
                }
                const reaction = document.createElement('span');
                reaction.textContent = emoji;
                reactionContainer.appendChild(reaction);
            };
            
            // --- Voice Recognition ---
            const setupSpeechRecognition = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { micButton.style.display = 'none'; return; }
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'en-US';
                recognition.onstart = () => { isRecording = true; micButton.style.color = 'var(--secondary-accent)'; aiAvatar.textContent = '🎤'; };
                recognition.onend = () => { isRecording = false; micButton.style.color = 'var(--text-color)'; aiAvatar.textContent = '🤖'; };
                recognition.onerror = (event) => console.error('Speech recognition error:', event.error);
                recognition.onresult = (event) => {
                    chatInput.value = event.results[0][0].transcript;
                    sendMessage();
                };
            };

            // --- Event Listeners ---
            sendButton.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
            menuToggle.addEventListener('click', () => sidebar.classList.toggle('open'));
            document.querySelector('.app-container').addEventListener('click', (e) => {
                if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && e.target !== menuToggle) {
                    sidebar.classList.remove('open');
                }
            });
            document.querySelectorAll('.vibe-btn').forEach(btn => {
                btn.addEventListener('click', () => handleVibeCheck(btn.dataset.vibe));
            });
            soundToggle.addEventListener('click', () => {
                isMuted = !isMuted;
                soundToggle.textContent = isMuted ? '🔇' : '🔊';
                showToast(isMuted ? 'Sound muted.' : 'Sound on.');
            });
            clearChatBtn.addEventListener('click', () => { chatHistory.innerHTML = ''; chat = []; });
            downloadPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                html2canvas(chatHistory).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    doc.save('pookie-ai-chat.pdf');
                });
            });
            document.querySelectorAll('.theme-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.body.className = `theme-${button.dataset.theme}`;
                    document.querySelector('.theme-btn.active').classList.remove('active');
                    button.classList.add('active');
                });
            });
            micButton.addEventListener('click', () => {
                if (!recognition) setupSpeechRecognition();
                if (isRecording) recognition.stop();
                else recognition.start();
            });

            // --- Initialization ---
            renderQuickPrompts();
            setupSpeechRecognition();
            if (!localStorage.getItem('pookieAIVisited')) {
                vibeModal.classList.remove('hidden');
                localStorage.setItem('pookieAIVisited', 'true');
            }
        });
    </script>
</body>
</html>
�